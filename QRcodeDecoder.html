<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<title>QR Decoder</title>
		 <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no" />
	</head>
	<body>
		<h1>QRcode Decoder</h1>
		<video id="video" width="400" height="300" autoplay muted playsinline ></video>
		<img id="img">
		<div style="display:none">
   		   <canvas id="canvas"></canvas>
		</div>
		<input type="button" id="action" value="解析"/>
   		<script type="text/javascript" src="grid.js"></script>
        <script type="text/javascript" src="version.js"></script>
        <script type="text/javascript" src="detector.js"></script>
        <script type="text/javascript" src="formatinf.js"></script>
        <script type="text/javascript" src="errorlevel.js"></script>
        <script type="text/javascript" src="bitmat.js"></script>
        <script type="text/javascript" src="datablock.js"></script>
        <script type="text/javascript" src="bmparser.js"></script>
        <script type="text/javascript" src="datamask.js"></script>
        <script type="text/javascript" src="rsdecoder.js"></script>
        <script type="text/javascript" src="gf256poly.js"></script>
        <script type="text/javascript" src="gf256.js"></script>
        <script type="text/javascript" src="decoder.js"></script>
        <script type="text/javascript" src="qrcode.js"></script>
        <script type="text/javascript" src="findpat.js"></script>
        <script type="text/javascript" src="alignpat.js"></script>
        <script type="text/javascript" src="databr.js"></script>
        <script type="text/javascript">
        	navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || window.navigator.mozGetUserMedia;
        	var video = document.getElementById('video');
        	var localStream = null;
        	navigator.getUserMedia(
        		{
                audio: false,
                video: { facingMode: { exact: "environment" } }
            },
        		function(stream) {
         		video.srcObject = stream;
         		localStream = stream;
        		},
        		function(err) {
        			console.log(err);
        		}
    		);

    		function decodeImageFromBase64(data, callback){
        		qrcode.callback = callback;
        		qrcode.decode(data)
    		}

    		document.getElementById("action").addEventListener('click',function(){
        		if(localStream) {
            		var canvas = document.getElementById('canvas');
            		var ctx = canvas.getContext('2d');
            		var img = document.getElementById('img');

            		var w = video.offsetWidth/1.8;
            		var h = video.offsetHeight;

            		canvas.setAttribute("width", w);
            		canvas.setAttribute("height", h);

            		ctx.drawImage(video, 0, 0, w, h);

            		decodeImageFromBase64(canvas.toDataURL('image/png'), function(result) {
                    alert(result);
            		});
        		}
   			},false);
		</script>
	</body>
</html>